#include <stdio.h>
#include "audio_bandpass.h"
#include "setqrg.h"

double audio_3k6[AUDIO_COFLEN] = {
    -0.00180822643169788	,
    0.00175035065149875	,
    0.000243107330384532	,
    0.000950946142380411	,
    0.00666432022247288	,
    -0.000395616659584211	,
    0.0118488303986969	,
    0.00394519373705955	,
    0.00749984283069159	,
    0.0150882748494704	,
    -0.00461763053229226	,
    0.019500919588566	,
    -0.00988919156771288	,
    -0.000954522098566054	,
    -0.0000000130195725740974	,
    -0.0425633403517203	,
    0.00543352794430622	,
    -0.0696538875685544	,
    -0.0310735873297984	,
    -0.0446085793155359	,
    -0.122008876362912	,
    0.0270508730954759	,
    -0.225400985770004	,
    0.0904262582926587	,
    0.728646579305466	,
    0.0904262582926587	,
    -0.225400985770004	,
    0.0270508730954759	,
    -0.122008876362912	,
    -0.0446085793155359	,
    -0.0310735873297984	,
    -0.0696538875685544	,
    0.00543352794430622	,
    -0.0425633403517203	,
    -0.0000000130195725740974	,
    -0.000954522098566054	,
    -0.00988919156771288	,
    0.019500919588566	,
    -0.00461763053229226	,
    0.0150882748494704	,
    0.00749984283069159	,
    0.00394519373705955	,
    0.0118488303986969	,
    -0.000395616659584211	,
    0.00666432022247288	,
    0.000950946142380411	,
    0.000243107330384532	,
0.00175035065149875	,
-0.00180822643169788	
};

double audio_3k0[AUDIO_COFLEN] = {
	-0.0027657670042757	,
    -0.00124756038116756	,
    -0.000944879404619674	,
    -0.00517583665022835	,
    0.00197150123313408	,
    -0.0008002837128512	,
    -0.00199840445837825	,
    0.0117507959982617	,
    0.00109187703742743	,
    0.00953902651087312	,
    0.0218812928237309	,
    -0.000992209299636933	,
    0.0221531929034617	,
    0.0146436233109023	,
    -0.0167124585327735	,
    0.0217827153197861	,
    -0.0279832485213663	,
    -0.0456460810450931	,
    0.00208899649075252	,
    -0.109648715413888	,
    -0.0589331428563851	,
    -0.0250596371777195	,
    -0.253411981118854	,
    0.131789342521592	,
    0.628885789001269	,
    0.131789342521592	,
    -0.253411981118854	,
    -0.0250596371777195	,
    -0.0589331428563851	,
    -0.109648715413888	,
    0.00208899649075252	,
    -0.0456460810450931	,
    -0.0279832485213663	,
    0.0217827153197861	,
    -0.0167124585327735	,
    0.0146436233109023	,
    0.0221531929034617	,
    -0.000992209299636933	,
    0.0218812928237309	,
    0.00953902651087312	,
    0.00109187703742743	,
    0.0117507959982617	,
    -0.00199840445837825	,
    -0.0008002837128512	,
    0.00197150123313408	,
    -0.00517583665022835	,
    -0.000944879404619674	,
    -0.00124756038116756	,
    -0.0027657670042757	
};

double audio_2k4[AUDIO_COFLEN] = {
    -0.00254238812949222	,
    -0.0016958320327019	,
    -0.0000670804853780756	,
    -0.00485933348058515	,
    -0.00687794636462034	,
    0.000963342435365769	,
    0.00143597350032062	,
    -0.00645125590128956	,
    0.0032622273480202	,
    0.0186289885210526	,
    0.00792253064198218	,
    0.00190402038354498	,
    0.0277076047050617	,
    0.027732538957221	,
    -0.0102216073137866	,
    -0.00336499788568892	,
    0.0253748622228186	,
    -0.0284249037990673	,
    -0.0842309963662504	,
    -0.0260717927808506	,
    -0.0204992808374725	,
    -0.176717040199041	,
    -0.166485925850821	,
    0.198176677342552	,
    0.448767427261854	,
    0.198176677342552	,
    -0.166485925850821	,
    -0.176717040199041	,
    -0.0204992808374725	,
    -0.0260717927808506	,
    -0.0842309963662504	,
    -0.0284249037990673	,
    0.0253748622228186	,
    -0.00336499788568892	,
    -0.0102216073137866	,
    0.027732538957221	,
    0.0277076047050617	,
    0.00190402038354498	,
    0.00792253064198218	,
    0.0186289885210526	,
    0.0032622273480202	,
    -0.00645125590128956	,
    0.00143597350032062	,
    0.000963342435365769	,
    -0.00687794636462034	,
    -0.00485933348058515	,
    -0.0000670804853780756	,
    -0.0016958320327019	,
    -0.00254238812949222	
};

double audio_1k8[AUDIO_COFLEN] = {
    -0.00224954406258427	,
    -0.00022189125037098	,
    0.00183814487979427	,
    0.000750064894741216	,
    -0.00231604323321387	,
    -0.00140001222521455	,
    0.00644391766512868	,
    0.0146040921121679	,
    0.0132142061085406	,
    0.00334244776999638	,
    -0.000795516631389992	,
    0.0102441495396823	,
    0.0239561144325045	,
    0.0166484879026256	,
    -0.0145272106222454	,
    -0.0398398827006316	,
    -0.0302908120173846	,
    -0.00156762318281113	,
    -0.00727695478580905	,
    -0.0734646172775466	,
    -0.146451102174869	,
    -0.129047270389843	,
    0.0155822060550836	,
    0.202993585735218	,
    0.289076280304134	,
    0.202993585735218	,
    0.0155822060550836	,
    -0.129047270389843	,
    -0.146451102174869	,
    -0.0734646172775466	,
    -0.00727695478580905	,
    -0.00156762318281113	,
    -0.0302908120173846	,
    -0.0398398827006316	,
    -0.0145272106222454	,
    0.0166484879026256	,
    0.0239561144325045	,
    0.0102441495396823	,
    -0.000795516631389992	,
    0.00334244776999638	,
    0.0132142061085406	,
    0.0146040921121679	,
    0.00644391766512868	,
    -0.00140001222521455	,
    -0.00231604323321387	,
    0.000750064894741216	,
    0.00183814487979427	,
    -0.00022189125037098	,
    -0.00224954406258427	
};


// =================================================================================
// FIR filters used by the down mixer
// =================================================================================

short audio_circular_buffer[AUDIO_COFLEN];
int audio_wr_idx = 0;

short audio_filter(short sample)
{
    // write value to buffer
    audio_circular_buffer[audio_wr_idx] = sample;
    
    // increment write index
    audio_wr_idx++;
    audio_wr_idx %= AUDIO_COFLEN;
    
    // calculate new value
    double *pcoeff = audio_1k8;
    if(filtermode == 1) pcoeff = audio_2k4;
    if(filtermode == 2) pcoeff = audio_3k0;
    if(filtermode == 3) pcoeff = audio_3k6;
    double y = 0;
    int idx = audio_wr_idx;
    for(int i = 0; i < AUDIO_COFLEN; i++)
    {
        y += (*pcoeff++ * (double)audio_circular_buffer[idx++]);
        if(idx >= AUDIO_COFLEN) idx=0;
    }

    if(y > 32767 || y < -32767)
        printf("audio_filter y too loud: %.0f\n",y);
    return (short)y;
}
